# Shadowing Mapping算法

Shadow Mapping背后的思路：我们以光的位置为视角进行渲染，我们能看到的东西都将被点亮，看不见的一定是在阴影之中了。    
第一步我们需要生成一张深度贴图(Depth Map)。深度贴图是从光的透视图里渲染的深度纹理，用它计算阴影。    
正确地生成深度贴图以后我们就可以开始生成阴影了。首先要检查一个片元是否在阴影中，把光空间片元位置转换为裁切空间的标准化设备坐标。为了得到片元的当前深度，我们简单获取投影向量的z坐标，它等于来自光的透视视角的片元的深度。实际的对比就是简单检查currentDepth是否高于closetDepth，如果是，那么片元就在阴影中。



# 实现思路

1. 构造深度贴图：创建一个帧缓冲对象，再创建一个2D纹理，提供给帧缓冲的深度缓冲使用；把生成的深度纹理作为帧缓冲的深度缓冲，得到从光的透视图下渲染场景的时候深度信息。
2. 渲染阴影：利用深度贴图，检验一个片元是否在阴影之中。
3. 改进阴影贴图：
   - 阴影失真问题：添加阴影偏移（shadow bias），对表面的深度应用一个偏移量。
   - 采样过多问题：储存一个边框颜色，然后把深度贴图的纹理环绕选项设置为GL_CLAMP_TO_BORDER，让所有超出深度贴图的坐标的深度范围是1.0；只要投影向量的z坐标大于1.0，我们就把shadow的值强制设为0.0。
   - PCF：从深度贴图中多次采样，每一次采样的纹理坐标都稍有不同。每个独立的样本可能在也可能不再阴影中。所有的次生结果接着结合在一起，进行平均化，我们就得到了柔和阴影。一个简单的PCF的实现是简单的从纹理像素四周对深度贴图采样，然后把结果平均起来。

4. 在渲染深度贴图的时候，使用正交投影或透视投影矩阵，实现不同的效果。